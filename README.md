# Telegram бот напоминаний о днях рождения

Бот хранит дни рождения ваших друзей в SQLite и напоминает в день события. Напоминания повторяются с заданной периодичностью, пока вы не отметите, что поздравили.

## Возможности
- Добавление дней рождения через диалог (/add) и массовый импорт (/bulk)
- Список с пагинацией и сортировкой «скоро → позже»
- Редактирование/удаление записей
- Привязка контакта: username по пересланному сообщению, телефон по «контакту»
- Умные напоминания:
  - Если есть username — ссылка `https://t.me/<username>`
  - Если только телефон — карточка контакта + кнопки действий
  - Если нет данных — кнопка «Привязать контакт» прямо в уведомлении
- Ежедневный сброс флага напоминаний в 00:05
 - Настройки пользователя: часовой пояс (UTC±N) и стартовый час окна напоминаний

## Требования
- Python 3.10+
- aiogram 3.7+
- APScheduler 3.10+

## Установка (локально)
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt

# Переменные окружения
export REMIND_BOT_TOKEN="<токен_бота_из_BotFather>"
export DB_PATH="birthdays.sqlite3"         # опционально; по умолчанию bot/db/birthdays.sqlite3
export TZ="Europe/Moscow"                  # опционально; по умолчанию UTC
export REMINDER_INTERVAL_MINUTES=60         # опционально; минимум 5

# Запуск (файл точки входа может отличаться в вашей структуре)
python bot/main.py     # если код в каталоге bot/
# или
python main.py         # если вы вынесли код на верхний уровень
```

## Команды бота
- `/start` — приветствие и кнопки
- `/add` — пошаговое добавление: имя → дата (ДД.ММ или ДД.ММ.ГГГГ) → телефон
- `/list` — список записей (по 5 на страницу), отсортирован по ближайшим ДР
- `/today` — вручную проверить и отправить «сегодняшние» напоминания
- `/bulk` — массовый импорт
- `/settings` — настройки уведомлений: часовой пояс и стартовый час

Редактирование записи (при клике по имени в списке):
- Имя, Дата, Телефон, TG username, «Привязать контакт», Удалить, Отмена

Привязка контакта:
- Перешлите сообщение от человека — подтянется `@username` и `tg_id`
- Отправьте контакт — подтянется телефон и, если это TG‑контакт, `tg_id`
- Можно ввести `@username` или номер текстом
- Нажмите «Готово» — бот аккуратно уберёт служебные сообщения

## Формат массового импорта (/bulk)
- Строка: `Имя;ДД.ММ[.ГГГГ][;телефон][;tg]`
- Разделители: `;`, `,` или табуляция
- Заголовок опционален: `name,date,phone,tg` (русские аналоги тоже ок)
- Дубликаты (Имя+Дата) пропускаются

Примеры строк:
```
Иван;12.02
Маша;04.08.1995;+79991234567;@masha
name,date,phone,tg
Лена Ерёмина,01.07.1990,,lena_e
```

## Переменные окружения
- `REMIND_BOT_TOKEN` — токен бота (обязательно)
- `DB_PATH` — путь к базе SQLite (по умолчанию `bot/db/birthdays.sqlite3`)
- `TZ` — часовой пояс, например `Europe/Moscow`
- `REMINDER_INTERVAL_MINUTES` — период напоминаний в минутах (минимум 5, по умолчанию 60)
- `ADMIN_UID` — UID администратора (показывает кнопку «Пользователи», доступ к /users)

## Сервис в Ubuntu (systemd)

В репозитории есть скрипт, который создаёт виртуальное окружение, устанавливает зависимости, готовит `.env` и настраивает службу systemd.

1) Отредактируйте `.env` (будет создан из примера):
```bash
cp .env.example .env
nano .env  # впишите REMIND_BOT_TOKEN и при необходимости другие переменные
```

2) Установите службу:
```bash
bash scripts/install_systemd.sh
```

Скрипт:
- создаст venv и установит зависимости
- определит точку входа (`bot/main.py` или `main.py`)
- создаст юнит `bd-reminder.service`
- включит автозапуск и запустит службу

Полезные команды:
```bash
sudo systemctl status bd-reminder
sudo journalctl -u bd-reminder -n 200 -f
sudo systemctl restart bd-reminder
sudo systemctl stop bd-reminder
```

## Бэкап базы
Файл SQLite можно просто копировать: остановите службу или сделайте копию WAL/SHM вместе с основным файлом.

## Примечания
- Возраст пишется только если в дате указан год.
- Бот не может «узнать» username по номеру телефона сам по себе — нужен пересланный месседж или контакт.

## Логи
Бот пишет подробные логи «тиков» планировщика в файл `reminder.log` рядом с `main.py`. Формат записей включает время тика и статистику по отправкам/причинам пропуска по каждому пользователю.

## Окно напоминаний и часовой пояс
Каждый пользователь может задать свой часовой пояс (целое смещение от UTC, например `+3` или `-1`) и час начала окна уведомлений (0–23). Бот шлёт напоминания только в интервале от указанного часа и до 23:00 по локальному времени пользователя. По умолчанию: UTC+0 и старт с 00:00.
